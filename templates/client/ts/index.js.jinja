const Decimal = require('decimal.js')

async function request(path, args, token = getBearerToken()) {
  let url = "{{ conf.host|append_slash }}" + urlSegmentName + "/action/" + action
  let response = await fetch(url, {
      method: "POST",
      headers: token ? { "Authorization": `Bearer ${token}` } : undefined,
      body: JSON.stringify(args)
  })
  let response_text = await response.text()
  let response_json = JSON.parse(response_text, (key, value) => {
    if (typeof value === 'object' && value != null) {
      if (value['$date']) {
        return new Date(value['$date'])
      } else if (value['$decimal']) {
        return new Decimal(value['$decimal'])
      }  else {
        return value
      }
    } else {
      return value
    }
  })
  if (400 <= response.status) {
      throw new TeoError(response_json.error)
  }
  return response_json
}

class TeoError extends Error {

  constructor(responseError) {
      super(responseError.message)
      this.type = responseError.type
      this.errors = responseError.errors
      Object.setPrototypeOf(this, TeoError.prototype)
  }

  get name() {
      return "TeoError"
  }
}


class Delegate {

  constructor(urlSegmentName, token) {
    this._urlSegmentName = urlSegmentName
    this._token = token
    return new Proxy(this, {
      get(target, name, receiver) {
        return function (args) {
          return request(
            target._urlSegmentName,
            name,
            args ?? {},
            target._token)
        }
      }
    })
  }

  $withToken(token) {
    let retval = new Delegate(this._urlSegmentName, this._token)
    retval._token = token
    return retval
  }
}

class {{ conf.class_name() }} {

  constructor() {
    this._token = undefined
    return new Proxy(this, {
      get(target, name, receiver) {
        if (name === '$withToken') {
          return (token) => {
            let retval = new Teo()
            retval._token = token
            return retval
          }
        } else {
          return new Delegate(name[0].toUpperCase() + name.slice(1), target._token)
        }
      },
    })
  }
}

const {{ conf.object_name }} = new {{ conf.class_name() }}()

module.exports = {
  Decimal,
  setBearerToken,
  getBearerToken,
  TeoError,
  {{ conf.object_name }},
}
